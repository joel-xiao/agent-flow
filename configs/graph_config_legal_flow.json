{
  "name": "legal_case_flow",
  "version": "1.4",
  "description": "智能法律案件评估与文书生成系统 - 完整实现（包含案卷图片生成）",
  "nodes": [
    {
      "id": "agent_case_intake",
      "type": "agent",
      "config": {
        "name": "case_intake_specialist",
        "driver": "qwen",
        "model": "qwen-max",
        "endpoint": "https://dashscope.aliyuncs.com/compatible-mode/v1",
        "role": "Case Analyzer",
        "prompt": "Analyze the legal case. Return raw JSON only (no markdown): {\"case_facts\": \"summary...\", \"legal_domain\": \"civil|criminal|corporate\", \"client_goal\": \"goal...\"}",
        "api_key": "${QWEN_API_KEY}",
        "intent": "analyze_case",
        "service": "default_service",
        "rules": {
          "field_extraction": {
            "user_input_fields": ["goal"],
            "extract_to_state": {
              "case_facts": "case_facts",
              "legal_domain": "legal_domain",
              "client_goal": "client_goal"
            }
          }
        }
      },
      "workflow": "workflow_legal"
    },
    {
      "id": "agent_civil_litigator",
      "type": "agent",
      "config": {
        "name": "civil_litigator",
        "driver": "qwen",
        "model": "qwen-max",
        "endpoint": "https://dashscope.aliyuncs.com/compatible-mode/v1",
        "role": "Legal Document Generator",
        "prompt": "Draft a Legal Demand Letter based on the case. Return raw JSON only (no markdown): {\"document_title\": \"Civil Demand Letter\", \"draft_content\": \"Full letter text...\"}",
        "api_key": "${QWEN_API_KEY}",
        "intent": "draft_civil",
        "service": "default_service",
        "rules": {
          "field_extraction": {
            "extract_to_state": {
              "draft_content": "current_draft",
              "document_title": "doc_title"
            }
          },
          "prompt_building": {
            "include_store_keys": ["case_facts", "client_goal"]
          }
        }
      },
      "workflow": "workflow_legal"
    },
    {
      "id": "agent_criminal_defender",
      "type": "agent",
      "config": {
        "name": "criminal_defender",
        "driver": "qwen",
        "model": "qwen-max",
        "endpoint": "https://dashscope.aliyuncs.com/compatible-mode/v1",
        "role": "Defense Memo Writer",
        "prompt": "Draft a defense strategy memo. Return raw JSON only (no markdown): {\"document_title\": \"Defense Strategy Memo\", \"draft_content\": \"Full memo text...\"}",
        "api_key": "${QWEN_API_KEY}",
        "intent": "draft_criminal",
        "service": "default_service",
        "rules": {
          "field_extraction": {
            "extract_to_state": {
              "draft_content": "current_draft",
              "document_title": "doc_title"
            }
          },
          "prompt_building": {
            "include_store_keys": ["case_facts", "client_goal"]
          }
        }
      },
      "workflow": "workflow_legal"
    },
    {
      "id": "agent_corporate_counsel",
      "type": "agent",
      "config": {
        "name": "corporate_counsel",
        "driver": "qwen",
        "model": "qwen-max",
        "endpoint": "https://dashscope.aliyuncs.com/compatible-mode/v1",
        "role": "Corporate Document Writer",
        "prompt": "Draft a corporate legal notice. Return raw JSON only (no markdown): {\"document_title\": \"Corporate Legal Notice\", \"draft_content\": \"Full notice text...\"}",
        "api_key": "${QWEN_API_KEY}",
        "intent": "draft_corporate",
        "service": "default_service",
        "rules": {
          "field_extraction": {
            "extract_to_state": {
              "draft_content": "current_draft",
              "document_title": "doc_title"
            }
          },
          "prompt_building": {
            "include_store_keys": ["case_facts", "client_goal"]
          }
        }
      },
      "workflow": "workflow_legal"
    },
    {
      "id": "agent_partner_review",
      "type": "agent",
      "config": {
        "name": "managing_partner",
        "driver": "qwen",
        "model": "qwen-max",
        "endpoint": "https://dashscope.aliyuncs.com/compatible-mode/v1",
        "role": "JSON Review API",
        "prompt": "Review the legal draft from previous message. If it's a proper legal document, approve it. If it's just advice/steps, revise it.\n\nReturn raw JSON only (no markdown): {\"status\": \"approved\"|\"revise\", \"critique\": \"brief feedback\", \"final_score\": 0-10}",
        "api_key": "${QWEN_API_KEY}",
        "intent": "review_draft",
        "service": "default_service",
        "rules": {
          "field_extraction": {
            "extract_to_state": {
              "status": "review_status",
              "critique": "review_feedback"
            }
          },
          "prompt_building": {
            "include_store_keys": ["current_draft", "doc_title", "case_facts"]
          }
        }
      },
      "workflow": "workflow_legal"
    },
    {
      "id": "loop_draft_revision",
      "type": "loop_node",
      "config": {
        "entry": "agent_partner_review",
        "condition": {
          "type": "state_equals",
          "key": "review_status",
          "value": "revise"
        },
        "max_iterations": 2
      },
      "workflow": "workflow_legal"
    },
    {
      "id": "agent_client_brief_en",
      "type": "agent",
      "config": {
        "name": "client_liaison_en",
        "driver": "qwen",
        "model": "qwen-max",
        "endpoint": "https://dashscope.aliyuncs.com/compatible-mode/v1",
        "role": "English Brief Writer",
        "prompt": "Write a simple English client brief. Return raw JSON only (no markdown): {\"brief_en\": \"Simple explanation...\"}",
        "api_key": "${QWEN_API_KEY}",
        "intent": "brief_en",
        "service": "default_service",
        "rules": {
          "field_extraction": {
            "extract_to_state": {
              "brief_en": "client_brief_en"
            }
          },
          "prompt_building": {
            "include_store_keys": ["current_draft"]
          }
        }
      },
      "workflow": "workflow_legal"
    },
    {
      "id": "agent_client_brief_cn",
      "type": "agent",
      "config": {
        "name": "client_liaison_cn",
        "driver": "qwen",
        "model": "qwen-max",
        "endpoint": "https://dashscope.aliyuncs.com/compatible-mode/v1",
        "role": "Chinese Brief Writer",
        "prompt": "Write a simple Chinese client brief. Return raw JSON only (no markdown): {\"brief_cn\": \"简单说明...\"}",
        "api_key": "${QWEN_API_KEY}",
        "intent": "brief_cn",
        "service": "default_service",
        "rules": {
          "field_extraction": {
            "extract_to_state": {
              "brief_cn": "client_brief_cn"
            }
          },
          "prompt_building": {
            "include_store_keys": ["current_draft"]
          }
        }
      },
      "workflow": "workflow_legal"
    },
    {
      "id": "node_parallel_client_brief",
      "type": "join_node",
      "config": {
        "strategy": "all",
        "inbound": ["agent_client_brief_en", "agent_client_brief_cn"]
      },
      "workflow": "workflow_legal"
    },
    {
      "id": "agent_visual_evidence",
      "type": "agent",
      "config": {
        "name": "forensic_artist",
        "driver": "qwen",
        "model": "qwen-max",
        "endpoint": "https://dashscope.aliyuncs.com/compatible-mode/v1",
        "role": "Evidence Designer",
        "prompt": "Design a courtroom visualization diagram. Return raw JSON only (no markdown): {\"evidence_prompt\": \"A diagram showing timeline/flow...\", \"style\": \"line_art\"|\"realistic\"}",
        "api_key": "${QWEN_API_KEY}",
        "intent": "design_evidence",
        "service": "default_service",
        "rules": {
          "field_extraction": {
            "extract_to_state": {
              "evidence_prompt": "image_prompt"
            }
          },
          "prompt_building": {
            "include_store_keys": ["case_facts"]
          }
        }
      },
      "workflow": "workflow_legal"
    },
    {
      "id": "agent_evidence_generator",
      "type": "agent",
      "config": {
        "name": "evidence_generator",
        "driver": "qwen",
        "model": "wan2.5-t2i-preview",
        "endpoint": "https://dashscope.aliyuncs.com/api/v1/services/aigc/text2image/image-synthesis",
        "api_key": "${QWEN_API_KEY}",
        "role": "Evidence Generator",
        "prompt": "Generate the visual evidence based on the prompt.",
        "intent": "generate_evidence",
        "service": "default_service",
        "metadata": {
          "api_format": "qwen"
        },
        "rules": {
            "prompt_building": {
                "include_store_keys": ["image_prompt"]
            }
        }
      },
      "workflow": "workflow_legal"
    },
    {
      "id": "tool_save_evidence",
      "type": "tool_node",
      "config": {
        "pipeline": "download_file",
        "params": {
          "save_dir": "legal_evidence",
          "filename_prefix": "evidence"
        }
      },
      "workflow": "workflow_legal"
    },
    {
      "id": "agent_case_compiler",
      "type": "agent",
      "config": {
        "name": "case_file_compiler",
        "driver": "qwen",
        "model": "qwen-max",
        "endpoint": "https://dashscope.aliyuncs.com/compatible-mode/v1",
        "role": "Case File Compiler",
        "prompt": "STRICTLY RETURN JSON ONLY (NO MARKDOWN BLOCK). Compile the final Case File with all documents, briefs, and visual evidence reference. Return raw JSON only: {\"case_file\": {\"summary\": \"...\", \"documents\": {\"legal_doc\": \"...\", \"brief_en\": \"...\", \"brief_cn\": \"...\"}, \"visuals\": \"evidence file path\", \"metadata\": {\"case_id\": \"...\"}}}",
        "api_key": "${QWEN_API_KEY}",
        "intent": "compile_file",
        "service": "default_service",
        "rules": {
          "field_extraction": {
            "extract_to_state": {
              "case_file": "final_case_file"
            }
          },
          "prompt_building": {
            "max_history_items": 50,
            "include_store_keys": ["doc_title", "current_draft", "client_brief_en", "client_brief_cn", "image_prompt", "case_facts"]
          }
        }
      },
      "workflow": "workflow_legal"
    },
    {
      "id": "agent_case_file_image_prompt",
      "type": "agent",
      "config": {
        "name": "case_file_image_prompt_generator",
        "driver": "qwen",
        "model": "qwen-max",
        "endpoint": "https://dashscope.aliyuncs.com/compatible-mode/v1",
        "role": "Case File Visual Designer",
        "prompt": "Design an image prompt for a professional legal case file document. The image should show a formal case file folder or document with key information visible. Return raw JSON only (no markdown): {\"case_file_image_prompt\": \"A professional legal case file...\", \"style\": \"document\"|\"infographic\"}",
        "api_key": "${QWEN_API_KEY}",
        "intent": "design_case_file_image",
        "service": "default_service",
        "rules": {
          "field_extraction": {
            "extract_to_state": {
              "case_file_image_prompt": "case_file_image_prompt"
            }
          },
          "prompt_building": {
            "include_store_keys": ["final_case_file", "doc_title", "case_facts"]
          }
        }
      },
      "workflow": "workflow_legal"
    },
    {
      "id": "agent_case_file_image_generator",
      "type": "agent",
      "config": {
        "name": "case_file_image_generator",
        "driver": "qwen",
        "model": "wan2.5-t2i-preview",
        "endpoint": "https://dashscope.aliyuncs.com/api/v1/services/aigc/text2image/image-synthesis",
        "api_key": "${QWEN_API_KEY}",
        "role": "Case File Image Generator",
        "prompt": "Generate the case file image based on the prompt.",
        "intent": "generate_case_file_image",
        "service": "default_service",
        "metadata": {
          "api_format": "qwen"
        },
        "rules": {
            "prompt_building": {
                "include_store_keys": ["case_file_image_prompt"]
            }
        }
      },
      "workflow": "workflow_legal"
    },
    {
      "id": "tool_save_case_file_image",
      "type": "tool_node",
      "config": {
        "pipeline": "download_file",
        "params": {
          "save_dir": "legal_evidence",
          "filename_prefix": "case_file"
        }
      },
      "workflow": "workflow_legal"
    },
    {
      "id": "node_end",
      "type": "terminal_node",
      "config": {},
      "workflow": "workflow_legal"
    },
    {
      "id": "workflow_legal",
      "type": "workflow",
      "config": {
        "name": "legal_processing_pipeline",
        "start": "agent_case_intake"
      }
    }
  ],
  "edges": [
    {
      "from": "agent_case_intake",
      "to": "agent_civil_litigator",
      "type": "conditional",
      "workflow": "workflow_legal",
      "condition": {
        "type": "state_equals",
        "key": "legal_domain",
        "value": "civil"
      }
    },
    {
      "from": "agent_case_intake",
      "to": "agent_criminal_defender",
      "type": "conditional",
      "workflow": "workflow_legal",
      "condition": {
        "type": "state_equals",
        "key": "legal_domain",
        "value": "criminal"
      }
    },
    {
      "from": "agent_case_intake",
      "to": "agent_corporate_counsel",
      "type": "conditional",
      "workflow": "workflow_legal",
      "condition": {
        "type": "state_equals",
        "key": "legal_domain",
        "value": "corporate"
      }
    },
    {
      "from": "agent_civil_litigator",
      "to": "agent_partner_review",
      "type": "always",
      "workflow": "workflow_legal"
    },
    {
      "from": "agent_criminal_defender",
      "to": "agent_partner_review",
      "type": "always",
      "workflow": "workflow_legal"
    },
    {
      "from": "agent_corporate_counsel",
      "to": "agent_partner_review",
      "type": "always",
      "workflow": "workflow_legal"
    },
    {
      "from": "agent_partner_review",
      "to": "loop_draft_revision",
      "type": "always",
      "workflow": "workflow_legal"
    },
    {
      "from": "loop_draft_revision",
      "to": "agent_client_brief_en",
      "type": "always",
      "workflow": "workflow_legal"
    },
    {
      "from": "loop_draft_revision",
      "to": "agent_client_brief_cn",
      "type": "always",
      "workflow": "workflow_legal"
    },
    {
      "from": "agent_client_brief_en",
      "to": "node_parallel_client_brief",
      "type": "always",
      "workflow": "workflow_legal"
    },
    {
      "from": "agent_client_brief_cn",
      "to": "node_parallel_client_brief",
      "type": "always",
      "workflow": "workflow_legal"
    },
    {
      "from": "node_parallel_client_brief",
      "to": "agent_visual_evidence",
      "type": "always",
      "workflow": "workflow_legal"
    },
    {
      "from": "agent_visual_evidence",
      "to": "agent_evidence_generator",
      "type": "always",
      "workflow": "workflow_legal"
    },
    {
      "from": "agent_evidence_generator",
      "to": "tool_save_evidence",
      "type": "always",
      "workflow": "workflow_legal"
    },
    {
      "from": "tool_save_evidence",
      "to": "agent_case_compiler",
      "type": "always",
      "workflow": "workflow_legal"
    },
    {
      "from": "agent_case_compiler",
      "to": "agent_case_file_image_prompt",
      "type": "always",
      "workflow": "workflow_legal"
    },
    {
      "from": "agent_case_file_image_prompt",
      "to": "agent_case_file_image_generator",
      "type": "always",
      "workflow": "workflow_legal"
    },
    {
      "from": "agent_case_file_image_generator",
      "to": "tool_save_case_file_image",
      "type": "always",
      "workflow": "workflow_legal"
    },
    {
      "from": "tool_save_case_file_image",
      "to": "node_end",
      "type": "always",
      "workflow": "workflow_legal"
    }
  ]
}
