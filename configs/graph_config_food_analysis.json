{
  "name": "food_analysis_app_advanced",
  "version": "2.0",
  "description": "高级食物分析应用 - 包含自动路由、并行处理、循环迭代",
  "nodes": [
    {
      "id": "agent_image_preprocessor",
      "type": "agent",
      "config": {
        "name": "image_preprocessor",
        "driver": "qwen",
        "model": "qwen-vl-max",
        "endpoint": "https://dashscope.aliyuncs.com/compatible-mode/v1",
        "role": "Image Preprocessor",
        "prompt": "Analyze the image quality. Return raw JSON only (no markdown): {\"quality\": \"high\"|\"low\"}",
        "api_key": "${QWEN_API_KEY}",
        "intent": "preprocess",
        "service": "default_service",
        "rules": {
          "field_extraction": {
            "image_quality": "quality"
          }
        }
      },
      "workflow": "workflow_food_analysis"
    },
    {
      "id": "node_loop_identifier",
      "type": "loop_node",
      "config": {
        "entry": "agent_food_identifier",
        "condition": {
          "type": "state_equals",
          "key": "confidence_check",
          "value": "pass"
        },
        "max_iterations": 3
      },
      "workflow": "workflow_food_analysis"
    },
    {
      "id": "agent_food_identifier",
      "type": "agent",
      "config": {
        "name": "food_identifier",
        "driver": "qwen",
        "model": "qwen-vl-max",
        "endpoint": "https://dashscope.aliyuncs.com/compatible-mode/v1",
        "role": "Food Identifier",
        "prompt": "Carefully analyze this food image and identify ALL individual food items and ingredients you can see. List each item separately. If you see multiple foods or ingredients, list them all. Return raw JSON only (no markdown): {\"foods\": [\"item1\", \"item2\", ...], \"confidence_check\": \"pass\"|\"retry\"}",
        "api_key": "${QWEN_API_KEY}",
        "intent": "identify",
        "service": "default_service",
        "rules": {
          "field_extraction": {
            "foods": "foods",
            "confidence_check": "confidence_check"
          }
        }
          },
      "workflow": "workflow_food_analysis"
    },
    {
      "id": "agent_smart_router",
      "type": "agent",
      "config": {
        "name": "smart_router",
        "driver": "qwen",
        "model": "qwen-max",
        "endpoint": "https://dashscope.aliyuncs.com/compatible-mode/v1",
        "role": "Router",
        "prompt": "Decide analysis depth. Return raw JSON only (no markdown): {\"analysis_route\": \"simple\"|\"detailed\"}",
        "api_key": "${QWEN_API_KEY}",
        "intent": "route",
        "service": "default_service",
        "rules": {
          "field_extraction": {
            "analysis_route": "analysis_route"
          }
        }
      },
      "workflow": "workflow_food_analysis"
    },
    {
      "id": "agent_portion_analyzer",
      "type": "agent",
      "config": {
        "name": "portion_analyzer",
        "driver": "qwen",
        "model": "qwen-vl-max",
        "endpoint": "https://dashscope.aliyuncs.com/compatible-mode/v1",
        "role": "Portion Analyzer",
        "prompt": "Based on the identified foods in the context, analyze the portion size of EACH food item. Estimate serving size (small/medium/large) and approximate weight in grams for each item. Return raw JSON: {\"portion_analysis\": [{\"food\": \"item_name\", \"size\": \"small|medium|large\", \"estimated_weight_g\": number}, ...]}",
        "api_key": "${QWEN_API_KEY}",
        "intent": "analyze_portion",
        "service": "default_service"
      },
      "workflow": "workflow_food_analysis"
    },
    {
      "id": "agent_nutrient_analyzer",
      "type": "agent",
      "config": {
        "name": "nutrient_analyzer",
        "driver": "qwen",
        "model": "qwen-max",
        "endpoint": "https://dashscope.aliyuncs.com/compatible-mode/v1",
        "role": "Nutrient Analyzer",
        "prompt": "Analyze vitamins and minerals. Return raw JSON only (no markdown).",
        "api_key": "${QWEN_API_KEY}",
        "intent": "analyze_nutrient",
        "service": "default_service"
      },
      "workflow": "workflow_food_analysis"
    },
    {
      "id": "node_join_analysis",
      "type": "join_node",
      "config": {
        "strategy": "all",
        "inbound": ["agent_portion_analyzer", "agent_nutrient_analyzer"]
      },
      "workflow": "workflow_food_analysis"
    },
    {
      "id": "agent_calorie_calculator",
      "type": "agent",
      "config": {
        "name": "calorie_calculator",
        "driver": "qwen",
        "model": "qwen-max",
        "endpoint": "https://dashscope.aliyuncs.com/compatible-mode/v1",
        "role": "Calorie Calculator",
        "prompt": "Based on the identified foods from previous analysis, estimate reasonable portion sizes and calculate the calorie content for EACH individual food item using standard nutrition databases. If portion data is available in context, use it; otherwise estimate standard serving sizes. Return detailed breakdown. Return raw JSON: {\"calorie_breakdown\": [{\"food\": \"item_name\", \"portion_g\": number, \"calories\": number}, ...], \"total_calories\": number}",
        "api_key": "${QWEN_API_KEY}",
        "intent": "calculate_calories",
        "service": "default_service"
      },
      "workflow": "workflow_food_analysis"
    },
    {
      "id": "agent_result_summarizer",
      "type": "agent",
      "config": {
        "name": "result_summarizer",
        "driver": "qwen",
        "model": "qwen-max",
        "endpoint": "https://dashscope.aliyuncs.com/compatible-mode/v1",
        "role": "Summarizer",
        "prompt": "Summarize all analysis results from the conversation history. List each identified food with its portion size and calorie content. Provide specific health recommendations based on the nutritional profile. Return raw JSON: {\"summary\": {\"total_calories\": number, \"total_foods\": count, \"confidence_score\": 0.0-1.0}, \"recommendations\": \"detailed advice\", \"foods\": [{\"name\": \"food_name\", \"portion_g\": number, \"calories\": number}, ...]}",
        "api_key": "${QWEN_API_KEY}",
        "intent": "summarize",
        "service": "default_service"
      },
      "workflow": "workflow_food_analysis"
    },
    {
      "id": "node_terminal",
      "type": "terminal_node",
      "config": {},
      "workflow": "workflow_food_analysis"
    },
    {
      "id": "workflow_food_analysis",
      "type": "workflow",
      "config": {
        "name": "food_analysis_flow",
        "start": "agent_image_preprocessor"
      }
    }
  ],
  "edges": [
    {
      "from": "agent_image_preprocessor",
      "to": "agent_food_identifier",
      "type": "always",
      "workflow": "workflow_food_analysis"
    },
    {
      "from": "agent_food_identifier",
      "to": "agent_smart_router",
      "type": "always",
      "workflow": "workflow_food_analysis"
    },
    {
      "from": "agent_smart_router",
      "to": "agent_calorie_calculator",
      "type": "always",
      "workflow": "workflow_food_analysis"
    },
    {
      "from": "agent_smart_router",
      "to": "agent_portion_analyzer",
      "type": "conditional",
      "condition": {
        "type": "state_equals",
        "key": "analysis_route",
        "value": "detailed"
      },
      "workflow": "workflow_food_analysis"
    },
    {
      "from": "agent_smart_router",
      "to": "agent_nutrient_analyzer",
      "type": "conditional",
      "condition": {
        "type": "state_equals",
        "key": "analysis_route",
        "value": "detailed"
      },
      "workflow": "workflow_food_analysis"
    },
    {
      "from": "agent_portion_analyzer",
      "to": "node_join_analysis",
      "type": "always",
      "workflow": "workflow_food_analysis"
    },
    {
      "from": "agent_nutrient_analyzer",
      "to": "node_join_analysis",
      "type": "always",
      "workflow": "workflow_food_analysis"
    },
    {
      "from": "node_join_analysis",
      "to": "agent_calorie_calculator",
      "type": "always",
      "workflow": "workflow_food_analysis"
    },
    {
      "from": "agent_calorie_calculator",
      "to": "agent_result_summarizer",
      "type": "always",
      "workflow": "workflow_food_analysis"
    },
    {
      "from": "agent_result_summarizer",
      "to": "node_terminal",
      "type": "always",
      "workflow": "workflow_food_analysis"
    }
  ]
}
