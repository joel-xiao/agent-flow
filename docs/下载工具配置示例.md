# 下载工具配置示例

## 概述

`DownloaderTool` 是 AgentFlow 的内置工具，支持自定义下载目录和文件名前缀。

## 默认行为

```rust
// 默认配置：保存到项目根目录 downloads/
ToolStep::new("downloader", serde_json::json!({}))
```

**结果**：
- 目录：`downloads/` （项目根目录下）
- 文件名：`file_1234567890.png`

## 配置选项

### 1. 自定义保存目录

#### 相对路径（推荐）

```rust
// 保存到 generated_images/
ToolStep::new("downloader", serde_json::json!({
    "save_dir": "generated_images"
}))

// 保存到 output/images/
ToolStep::new("downloader", serde_json::json!({
    "save_dir": "output/images"
}))

// 保存到多级目录
ToolStep::new("downloader", serde_json::json!({
    "save_dir": "storage/marketing/2024"
}))
```

#### 绝对路径

```rust
// Mac/Linux
ToolStep::new("downloader", serde_json::json!({
    "save_dir": "/Users/username/Downloads"
}))

// Windows
ToolStep::new("downloader", serde_json::json!({
    "save_dir": "C:\\Users\\username\\Downloads"
}))
```

### 2. 自定义文件名前缀

```rust
// 文件名：marketing_1234567890.png
ToolStep::new("downloader", serde_json::json!({
    "filename_prefix": "marketing"
}))

// 文件名：product_image_1234567890.jpg
ToolStep::new("downloader", serde_json::json!({
    "filename_prefix": "product_image"
}))
```

### 3. 组合配置

```rust
// 自定义目录 + 自定义前缀
ToolStep::new("downloader", serde_json::json!({
    "save_dir": "output/marketing",
    "filename_prefix": "campaign"
}))
```

**结果**：`output/marketing/campaign_1234567890.png`

### 4. 直接指定 URL（不自动提取）

```rust
// 手动指定 URL 而不是从上下文自动提取
ToolStep::new("downloader", serde_json::json!({
    "url": "https://example.com/image.png",
    "save_dir": "manual_downloads",
    "filename_prefix": "manual"
}))
```

## 完整示例

### 示例 1：营销内容生成系统

```rust
use agentflow::tools::{ToolOrchestrator, ToolPipeline, ToolStep, ToolStrategy};

let mut orchestrator = ToolOrchestrator::new(bundle.tools.clone());

// 注册下载 pipeline
let download_pipeline = ToolPipeline::new(
    "download_file",
    ToolStrategy::Sequential(vec![
        ToolStep::new("downloader", serde_json::json!({
            "save_dir": "generated_images",      // 保存到 generated_images/
            "filename_prefix": "marketing"       // 文件名前缀 marketing_
        }))
    ])
);
orchestrator.register_pipeline(download_pipeline)?;
```

**结果**：`generated_images/marketing_1732435200.png`

### 示例 2：多任务下载

```rust
// Pipeline 1: 下载营销图片
let marketing_pipeline = ToolPipeline::new(
    "download_marketing",
    ToolStrategy::Sequential(vec![
        ToolStep::new("downloader", serde_json::json!({
            "save_dir": "output/marketing",
            "filename_prefix": "campaign"
        }))
    ])
);

// Pipeline 2: 下载产品图片
let product_pipeline = ToolPipeline::new(
    "download_product",
    ToolStrategy::Sequential(vec![
        ToolStep::new("downloader", serde_json::json!({
            "save_dir": "output/products",
            "filename_prefix": "product"
        }))
    ])
);

orchestrator.register_pipeline(marketing_pipeline)?;
orchestrator.register_pipeline(product_pipeline)?;
```

### 示例 3：按日期组织

```rust
use chrono::Local;

let today = Local::now().format("%Y-%m-%d").to_string();
let save_dir = format!("downloads/{}", today);

let download_pipeline = ToolPipeline::new(
    "download_file",
    ToolStrategy::Sequential(vec![
        ToolStep::new("downloader", serde_json::json!({
            "save_dir": save_dir,
            "filename_prefix": "daily"
        }))
    ])
);
```

**结果**：`downloads/2024-11-25/daily_1732435200.png`

### 示例 4：并行下载多个文件

```rust
// 假设上下文中有多个图片 URL
let download_pipeline = ToolPipeline::new(
    "download_multiple",
    ToolStrategy::Parallel(vec![
        ToolStep::new("downloader", serde_json::json!({
            "save_dir": "output/batch1",
            "filename_prefix": "img1"
        })),
        ToolStep::new("downloader", serde_json::json!({
            "save_dir": "output/batch2",
            "filename_prefix": "img2"
        })),
    ])
);
```

## JSON 配置中的使用

### 基本配置

```json
{
  "nodes": [
    {
      "id": "tool_downloader",
      "type": "tool_node",
      "config": {
        "pipeline": "download_file"
      }
    }
  ]
}
```

### 在应用代码中配置

```rust
// 应用启动时注册 pipeline
let download_pipeline = ToolPipeline::new(
    "download_file",
    ToolStrategy::Sequential(vec![
        ToolStep::new("downloader", serde_json::json!({
            "save_dir": "downloads",           // 项目根目录下
            "filename_prefix": "file"
        }))
    ])
);
orchestrator.register_pipeline(download_pipeline)?;
```

## 目录结构示例

### 推荐的项目目录结构

```
agentflow/
├── configs/
├── examples/
├── src/
├── downloads/              ← 默认下载目录
│   ├── file_1732435200.png
│   └── file_1732435201.jpg
├── generated_images/       ← 自定义：营销图片
│   ├── marketing_1732435200.png
│   └── marketing_1732435201.png
├── output/                 ← 自定义：结构化输出
│   ├── marketing/
│   │   └── campaign_1732435200.png
│   └── products/
│       └── product_1732435200.jpg
└── storage/                ← 自定义：长期存储
    └── 2024/
        └── 11/
            └── image_1732435200.png
```

## 文件命名规则

### 自动生成的文件名格式

```
{filename_prefix}_{timestamp}.{extension}
```

**组成部分**：
- `filename_prefix`：自定义前缀（默认 "file"）
- `timestamp`：Unix 时间戳（秒）
- `extension`：自动推断的文件扩展名

### 支持的文件类型

| 类型 | 扩展名 | Content-Type |
|------|--------|--------------|
| 图片 | png, jpg, gif, webp, svg | image/* |
| 音频 | mp3, wav, ogg, aac | audio/* |
| 视频 | mp4, mpeg, mov, avi, webm | video/* |
| 文档 | pdf, json, txt | application/*, text/* |

## 常见场景

### 场景 1：AI 图片生成后下载

```rust
// Workflow: AI生成图片 → 自动下载
// 1. agent_image_generator 生成图片（返回 image_url）
// 2. tool_downloader 自动提取 image_url 并下载

let download_pipeline = ToolPipeline::new(
    "download_file",
    ToolStrategy::Sequential(vec![
        ToolStep::new("downloader", serde_json::json!({
            "save_dir": "generated_images",
            "filename_prefix": "ai_generated"
        }))
    ])
);
```

### 场景 2：批量下载网络资源

```rust
// 顺序下载多个 URL（从不同的消息中提取）
let batch_pipeline = ToolPipeline::new(
    "download_batch",
    ToolStrategy::Sequential(vec![
        ToolStep::new("downloader", serde_json::json!({
            "save_dir": "batch_downloads",
            "filename_prefix": "batch1"
        })),
        ToolStep::new("downloader", serde_json::json!({
            "save_dir": "batch_downloads",
            "filename_prefix": "batch2"
        })),
    ])
);
```

### 场景 3：失败重试

```rust
// 使用 Fallback 策略，尝试不同的配置
let retry_pipeline = ToolPipeline::new(
    "download_with_retry",
    ToolStrategy::Fallback(vec![
        ToolStep::new("downloader", serde_json::json!({
            "save_dir": "downloads"
        })),
        ToolStep::new("downloader", serde_json::json!({
            "save_dir": "/tmp/downloads"  // 备用目录
        })),
    ])
);
```

## 环境变量配置

可以使用环境变量动态配置下载目录：

```rust
use std::env;

let save_dir = env::var("DOWNLOAD_DIR").unwrap_or_else(|_| "downloads".to_string());

let download_pipeline = ToolPipeline::new(
    "download_file",
    ToolStrategy::Sequential(vec![
        ToolStep::new("downloader", serde_json::json!({
            "save_dir": save_dir,
            "filename_prefix": "file"
        }))
    ])
);
```

运行时：
```bash
export DOWNLOAD_DIR="/Users/username/MyDownloads"
cargo run --example marketing_generator
```

## 最佳实践

### 1. 使用相对路径
✅ **推荐**：
```rust
"save_dir": "output/images"
```

❌ **不推荐**（不可移植）：
```rust
"save_dir": "/Users/specific_user/Downloads"
```

### 2. 组织目录结构
按业务逻辑组织：
```
downloads/
├── marketing/
├── products/
└── temporary/
```

### 3. 使用有意义的前缀
```rust
// ✅ 清晰
"filename_prefix": "marketing_campaign"
"filename_prefix": "product_image"

// ❌ 模糊
"filename_prefix": "file"
"filename_prefix": "download"
```

### 4. 定期清理
```rust
// 可以添加定时任务清理旧文件
// 例如：删除 7 天前的临时文件
```

## 错误处理

### 目录不存在
工具会**自动创建**目录（包括多级目录）：
```rust
"save_dir": "a/b/c/d"  // 自动创建 a/b/c/d/
```

### 权限问题
```rust
// 如果目录没有写权限，会返回错误
Err(AgentFlowError::Other("Failed to create directory: Permission denied"))
```

### URL 无效
```rust
// 如果上下文中没有找到 URL，会返回错误
Err(AgentFlowError::Other("No URL found in input or context"))
```

## 总结

- ✅ **默认目录**：`downloads/`（项目根目录）
- ✅ **自定义目录**：通过 `save_dir` 参数
- ✅ **自定义前缀**：通过 `filename_prefix` 参数
- ✅ **自动创建**：目录不存在时自动创建
- ✅ **灵活配置**：支持相对路径和绝对路径
- ✅ **智能命名**：自动添加时间戳和扩展名

