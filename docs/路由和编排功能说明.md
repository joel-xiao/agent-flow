# 路由和编排功能说明

## 概述

AgentFlow 完全支持**路由**和**编排**功能，这是构建复杂工作流的核心能力。

## ✅ 路由功能

### 1. 决策节点 (Decision Node)

决策节点支持基于条件的路由选择，支持两种策略：

- **FirstMatch**: 第一个匹配的条件分支被选中
- **AllMatches**: 所有匹配的条件分支都会被选中（支持多路径并行）

### 2. 条件路由

支持多种条件类型：

- `state_equals` - 状态值等于
- `state_not_equals` - 状态值不等于
- `state_exists` - 状态存在
- `state_absent` - 状态不存在

### 3. 边的条件转换

每条边都可以有条件，只有在条件满足时才会执行。

## ✅ 编排功能

### 1. Join 节点 (合并编排)

支持并行执行后的合并，支持三种策略：

- **All**: 等待所有输入节点完成
- **Any**: 任意一个输入节点完成即可
- **Count(N)**: 等待 N 个输入节点完成

### 2. Loop 节点 (循环编排)

支持循环执行，包含：

- **Entry**: 循环入口节点
- **Condition**: 循环条件（可选的继续条件）
- **Max Iterations**: 最大迭代次数
- **Exit**: 循环退出节点（可选）

### 3. Tool 编排器 (Tool Orchestrator)

支持工具的复杂编排策略：

- **Sequential**: 顺序执行
- **Parallel**: 并行执行
- **Fallback**: 故障转移（第一个失败时尝试下一个）

### 4. Agent 分支 (Agent Branch)

Agent 可以返回多个分支，支持动态路由。

## 配置示例

### 决策节点配置

```json
{
  "id": "node_decision",
  "type": "decision_node",
  "config": {
    "policy": "first_match",
    "branches": [
      {
        "target": "node_route_a",
        "name": "to_a",
        "condition": {
          "type": "state_equals",
          "key": "route",
          "value": "a"
        }
      },
      {
        "target": "node_route_b",
        "name": "to_b",
        "condition": {
          "type": "state_equals",
          "key": "route",
          "value": "b"
        }
      }
    ]
  },
  "workflow": "workflow_decision_flow"
}
```

### Join 节点配置

```json
{
  "id": "node_join",
  "type": "join_node",
  "config": {
    "strategy": "all",
    "inbound": ["node_worker_a", "node_worker_b"]
  },
  "workflow": "workflow_parallel_flow"
}
```

### Loop 节点配置

```json
{
  "id": "node_loop",
  "type": "loop_node",
  "config": {
    "entry": "node_processor",
    "condition": {
      "type": "state_equals",
      "key": "continue",
      "value": "true"
    },
    "max_iterations": 10,
    "exit": "node_finalizer"
  },
  "workflow": "workflow_loop_flow"
}
```

### 条件边配置

```json
{
  "from": "node_checker",
  "to": "node_handler_a",
  "type": "conditional",
  "name": "to_a",
  "condition": {
    "type": "state_equals",
    "key": "path",
    "value": "a"
  },
  "workflow": "workflow_conditional_flow"
}
```

## 功能对比

| 功能 | 支持状态 | 说明 |
|------|---------|------|
| 决策路由 | ✅ 完全支持 | Decision Node + 条件分支 |
| 条件边 | ✅ 完全支持 | Edge 级别的条件路由 |
| 并行编排 | ✅ 完全支持 | Join Node + Parallel 策略 |
| 顺序编排 | ✅ 完全支持 | 通过边的顺序连接 |
| 循环编排 | ✅ 完全支持 | Loop Node |
| 工具编排 | ✅ 完全支持 | Tool Orchestrator |
| 动态路由 | ✅ 完全支持 | Agent Branch Action |
| 故障转移 | ✅ 完全支持 | Fallback 策略 |

## 使用场景

### 1. 条件路由场景

```json
// 根据用户类型路由到不同的处理节点
{
  "from": "node_analyzer",
  "to": "node_decision",
  "type": "always"
},
{
  "from": "node_decision",
  "to": "node_vip_handler",
  "type": "conditional",
  "condition": {
    "type": "state_equals",
    "key": "user_type",
    "value": "vip"
  }
}
```

### 2. 并行编排场景

```json
// 多个 worker 并行处理，然后合并结果
{
  "id": "node_splitter",
  "type": "agent_node",
  "config": { "agent": "agent_splitter" }
},
{
  "id": "node_worker_a",
  "type": "agent_node",
  "config": { "agent": "agent_worker_a" }
},
{
  "id": "node_worker_b",
  "type": "agent_node",
  "config": { "agent": "agent_worker_b" }
},
{
  "id": "node_join",
  "type": "join_node",
  "config": {
    "strategy": "all",
    "inbound": ["node_worker_a", "node_worker_b"]
  }
},
{
  "from": "node_splitter",
  "to": "node_worker_a",
  "type": "always"
},
{
  "from": "node_splitter",
  "to": "node_worker_b",
  "type": "always"
},
{
  "from": "node_worker_a",
  "to": "node_join",
  "type": "always"
},
{
  "from": "node_worker_b",
  "to": "node_join",
  "type": "always"
}
```

### 3. 循环编排场景

```json
// 处理队列，直到队列为空
{
  "id": "node_loop",
  "type": "loop_node",
  "config": {
    "entry": "node_processor",
    "condition": {
      "type": "state_equals",
      "key": "queue_empty",
      "value": "false"
    },
    "max_iterations": 100
  }
},
{
  "from": "node_loop",
  "to": "node_processor",
  "type": "always"
}
```

## 路由模式

### 手动路由（✅ 已支持）

通过 Decision 节点基于状态条件进行路由：

```json
{
  "id": "node_decision",
  "type": "decision_node",
  "config": {
    "policy": "first_match",
    "branches": [
      {
        "target": "node_route_a",
        "condition": {
          "type": "state_equals",
          "key": "route",
          "value": "a"
        }
      }
    ]
  }
}
```

### 自动路由（✅ 已完全支持）

由 LLM 自动分析输入并生成路由标签，然后自动路由到对应节点。通过 `ConfigDrivenAgent` 的 `route_mode: "auto"` 配置启用。详细说明请参考 [自动和手动路由说明](./自动和手动路由说明.md) 和 [自动路由实现方案](./自动路由实现方案.md)。

## 总结

AgentFlow 完全支持路由和编排功能，可以构建复杂的、动态的工作流系统。通过组合使用这些功能，可以实现：

1. **智能路由**: 
   - 手动路由：根据状态动态选择执行路径（✅ 已支持）
   - 自动路由：LLM 自动分析和路由（✅ 已支持）
2. **并行处理**: 多个任务同时执行
3. **循环处理**: 重复执行直到条件满足
4. **故障转移**: 自动切换备用方案
5. **复杂编排**: 混合使用多种编排策略

详细路由说明请参考：
- [自动和手动路由说明](./自动和手动路由说明.md)
- [自动路由实现方案](./自动路由实现方案.md)

