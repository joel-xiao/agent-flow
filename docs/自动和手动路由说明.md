# 自动路由和手动路由说明

## 概述

AgentFlow 支持两种路由模式：

1. **自动路由**：由 LLM 自动分析输入，生成路由标签，然后自动路由到对应节点
2. **手动路由**：在配置中预先定义路由规则（Decision 节点），基于状态值判断路由

## ✅ 手动路由（已完全支持）

### 工作原理

1. 通过 Agent 或 Tool 设置状态值（路由标签）
2. Decision 节点检查状态值
3. 根据条件匹配路由到对应的分支

### 配置示例

```json
{
  "id": "agent_labeler",
  "type": "agent",
  "config": {
    "name": "labeler",
    "role": "Label Generator",
    "prompt": "Analyze the request and set a route label in the state: 'route_a' or 'route_b'"
  }
},
{
  "id": "node_decision",
  "type": "decision_node",
  "config": {
    "policy": "first_match",
    "branches": [
      {
        "target": "node_route_a",
        "name": "to_a",
        "condition": {
          "type": "state_equals",
          "key": "route",
          "value": "a"
        }
      },
      {
        "target": "node_route_b",
        "name": "to_b",
        "condition": {
          "type": "state_equals",
          "key": "route",
          "value": "b"
        }
      }
    ]
  }
}
```

### 工作流程

```
Agent (设置状态) → Decision 节点 (检查状态) → 路由到对应分支
```

## ✅ 自动路由（已完全支持）

### 当前状态

- ✅ 基础设施已支持：`AgentAction::Branch` 可以返回多个分支
- ✅ 已实现：`ConfigDrivenAgent` 已支持 LLM 生成路由标签

### 实现方案

#### 方案 1：扩展 ConfigDrivenAgent 支持路由标签

让 Agent 的 LLM 响应包含路由信息，例如：

```json
{
  "response": "处理结果...",
  "route": "route_a",  // LLM 自动生成的路由标签
  "branches": {        // 或者多个分支
    "route_a": "...",
    "route_b": "..."
  }
}
```

#### 方案 2：专门的 Router Agent

创建一个专门的路由 Agent，它只负责：
1. 分析输入
2. 生成路由标签
3. 返回 `AgentAction::Branch` 进行动态路由

### 推荐的实现方式

**自动路由 Agent 配置**：

```json
{
  "id": "agent_auto_router",
  "type": "agent",
  "config": {
    "name": "auto_router",
    "role": "Intelligent Router",
    "prompt": "You are an intelligent router. Analyze the request and determine which route to take. Respond with JSON: {\"route\": \"route_a\" or \"route_b\", \"reason\": \"...\"}",
    "route_mode": "auto",  // 新字段：启用自动路由
    "route_targets": ["node_route_a", "node_route_b"]  // 可路由的目标节点
  }
}
```

## 功能对比

| 特性 | 手动路由 | 自动路由 |
|------|---------|---------|
| 路由决策者 | 用户/配置 | LLM |
| 路由标签来源 | 手动设置状态值 | LLM 自动生成 |
| 配置复杂度 | 需要 Decision 节点 | 只需要 Agent 配置 |
| 灵活性 | 规则固定 | 动态智能 |
| 当前支持 | ✅ 完全支持 | ✅ 完全支持 |

## 实现自动路由的步骤

### 步骤 1：扩展 AgentConfig

```rust
pub struct AgentConfig {
    // ... 现有字段
    pub route_mode: Option<String>,  // "auto" 或 "manual"
    pub route_targets: Option<Vec<String>>,  // 可路由的目标节点
}
```

### 步骤 2：扩展 ConfigDrivenAgent

在 `ConfigDrivenAgent::on_message` 中：

1. 如果 `route_mode == "auto"`，让 LLM 生成路由信息
2. 解析 LLM 响应中的路由标签
3. 返回 `AgentAction::Branch` 进行动态路由

### 步骤 3：配置示例

```json
{
  "id": "agent_smart_router",
  "type": "agent",
  "config": {
    "name": "smart_router",
    "driver": "qwen",
    "role": "Smart Router",
    "prompt": "Analyze the request and determine the best route. Respond with: {\"route\": \"a\" or \"b\", \"response\": \"your analysis\"}",
    "model": "qwen-max",
    "route_mode": "auto",
    "route_targets": ["node_handler_a", "node_handler_b"]
  }
}
```

## 使用场景

### 手动路由场景

- **规则明确**：路由规则清晰，不需要 AI 判断
- **性能优先**：不需要 LLM 调用，直接基于状态判断
- **可控性强**：路由逻辑完全由配置控制

示例：根据用户类型（VIP/普通用户）路由到不同处理节点

### 自动路由场景

- **智能判断**：需要 AI 分析内容才能决定路由
- **动态性强**：路由规则难以预先定义
- **复杂场景**：需要理解语义和上下文

示例：根据客户问题的紧急程度和类型，智能路由到不同的客服团队

## 当前最佳实践

### 手动路由（推荐使用）

```json
{
  "nodes": [
    {
      "id": "agent_analyzer",
      "type": "agent_node",
      "config": {
        "agent": "agent_analyzer"
      }
    },
    {
      "id": "node_decision",
      "type": "decision_node",
      "config": {
        "policy": "first_match",
        "branches": [
          {
            "target": "node_route_a",
            "condition": {
              "type": "state_equals",
              "key": "route",
              "value": "a"
            }
          }
        ]
      }
    }
  ],
  "edges": [
    {
      "from": "agent_analyzer",
      "to": "node_decision",
      "type": "always"
    },
    {
      "from": "node_decision",
      "to": "node_route_a",
      "type": "conditional",
      "condition": {
        "type": "state_equals",
        "key": "route",
        "value": "a"
      }
    }
  ]
}
```

### 自动路由（✅ 已完全支持）

通过 `ConfigDrivenAgent` 的 `route_mode: "auto"` 配置即可启用自动路由功能，无需自定义 Agent 实现。

## 总结

- ✅ **手动路由**：已完全支持，使用 Decision 节点即可
- ✅ **自动路由**：已完全支持，通过 `ConfigDrivenAgent` 的 `route_mode: "auto"` 配置启用

### 使用自动路由

在 Agent 配置中设置 `route_mode: "auto"` 即可启用自动路由功能：

```json
{
  "id": "agent_router",
  "type": "agent",
  "config": {
    "name": "router",
    "route_mode": "auto",
    "route_targets": ["node_handler_a", "node_handler_b"],
    "default_route": "node_default"
  }
}
```

详细实现说明请参考 [自动路由实现方案](./自动路由实现方案.md)。

