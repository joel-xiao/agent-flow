# 食物识别分析应用设计文档

## 应用概述

一款基于 AgentFlow 的智能食物识别与分析应用，能够：
1. **识别图片中的食物** - 使用视觉模型识别食物类型
2. **分析食物分量** - 估算食物的重量和体积
3. **计算食物大卡** - 根据食物类型和分量计算卡路里

## 功能需求

### 核心功能

1. **图像识别**
   - 输入：食物图片（支持多种格式）
   - 输出：识别出的食物列表（名称、置信度）

2. **分量分析**
   - 输入：食物识别结果、图片信息
   - 输出：每种食物的估算分量（重量、体积、数量）

3. **卡路里计算**
   - 输入：食物类型、分量信息
   - 输出：总卡路里、营养成分分解

### 扩展功能

4. **智能路由**
   - 根据图片质量自动选择处理路径
   - 支持单食物和多食物场景

5. **并行处理**
   - 多食物同时识别和分析
   - 结果合并和汇总

6. **结果验证**
   - 验证识别结果的合理性
   - 提供置信度评分

## 工作流设计

### 整体架构

```
输入图片
    ↓
[图像预处理 Agent]
    ↓
[食物识别 Agent] ──→ [Decision Node] ──→ [单食物路径] ──→ [Join Node]
    ↓                                          ↓
[分量分析 Agent] ←──────────────────────── [多食物路径]
    ↓                                          ↓
[卡路里计算 Agent] ←──────────────────────── [并行处理]
    ↓
[结果汇总 Agent]
    ↓
输出结果
```

### 详细工作流

#### 工作流 1: 主流程 (workflow_food_analysis)

**节点序列**：
1. `node_image_preprocessor` - 图像预处理 Agent
2. `node_food_identifier` - 食物识别 Agent（视觉模型）
3. `node_decision` - Decision 节点（判断单食物/多食物）
4. `node_single_food_handler` - 单食物处理路径
5. `node_multi_food_handler` - 多食物处理路径
6. `node_join` - Join 节点（合并结果）
7. `node_portion_analyzer` - 分量分析 Agent
8. `node_calorie_calculator` - 卡路里计算 Agent
9. `node_result_summarizer` - 结果汇总 Agent
10. `node_finish` - Terminal 节点

**边连接**：
- `image_preprocessor` → `food_identifier` (always)
- `food_identifier` → `decision` (always)
- `decision` → `single_food_handler` (conditional: food_count == 1)
- `decision` → `multi_food_handler` (conditional: food_count > 1)
- `single_food_handler` → `join` (always)
- `multi_food_handler` → `join` (always)
- `join` → `portion_analyzer` (always)
- `portion_analyzer` → `calorie_calculator` (always)
- `calorie_calculator` → `result_summarizer` (always)
- `result_summarizer` → `finish` (always)

#### 工作流 2: 多食物并行处理 (workflow_parallel_food_analysis)

**节点序列**：
1. `node_food_splitter` - 食物分割 Agent（将多食物拆分为单个任务）
2. `node_worker_food_1` - Worker A（处理食物1）
3. `node_worker_food_2` - Worker B（处理食物2）
4. `node_worker_food_3` - Worker C（处理食物3）
5. `node_join_parallel` - Join 节点（等待所有 Worker 完成）
6. `node_merge_results` - 结果合并 Agent

**边连接**：
- `food_splitter` → `worker_food_1` (always)
- `food_splitter` → `worker_food_2` (always)
- `food_splitter` → `worker_food_3` (always)
- `worker_food_1` → `join_parallel` (always)
- `worker_food_2` → `join_parallel` (always)
- `worker_food_3` → `join_parallel` (always)
- `join_parallel` → `merge_results` (always)

## Agent 设计

### 1. 图像预处理 Agent (agent_image_preprocessor)

**职责**：
- 验证图片格式和大小
- 图片压缩和优化
- 提取图片元数据

**配置**：
```json
{
  "name": "image_preprocessor",
  "driver": "qwen",
  "role": "Image Preprocessor",
  "prompt": "You are an image preprocessing expert. Analyze the image and prepare it for food recognition.",
  "model": "qwen-vl-max",
  "intent": "preprocess",
  "service": "service_qwen"
}
```

### 2. 食物识别 Agent (agent_food_identifier)

**职责**：
- 识别图片中的食物
- 返回食物列表和置信度
- 支持多食物识别

**配置**：
```json
{
  "name": "food_identifier",
  "driver": "qwen",
  "role": "Food Identification Expert",
  "prompt": "You are an experienced food identification expert. Identify all foods in the image and return a JSON list with food names and confidence scores.",
  "model": "qwen-vl-max",
  "intent": "identify",
  "service": "service_qwen",
  "rules": {
    "field_extraction": {
      "foods": "foods",
      "food_count": "food_count"
    },
    "payload_building": {
      "template": "Identify foods in this image: {image_url}"
    }
  }
}
```

### 3. 分量分析 Agent (agent_portion_analyzer)

**职责**：
- 分析每种食物的分量
- 估算重量、体积、数量
- 考虑参考物（如盘子、手等）

**配置**：
```json
{
  "name": "portion_analyzer",
  "driver": "qwen",
  "role": "Portion Estimation Expert",
  "prompt": "You are a professional portion estimation expert. Analyze the food portions in the image and estimate weight, volume, and quantity for each food item.",
  "model": "qwen-vl-max",
  "intent": "estimate",
  "service": "service_qwen"
}
```

### 4. 卡路里计算 Agent (agent_calorie_calculator)

**职责**：
- 根据食物类型和分量计算卡路里
- 提供营养成分分解
- 支持多种食物组合

**配置**：
```json
{
  "name": "calorie_calculator",
  "driver": "qwen",
  "role": "Nutrition Calculator",
  "prompt": "You are a nutrition expert. Calculate calories and nutritional information based on food type and portion size.",
  "model": "qwen-max",
  "intent": "calculate",
  "service": "service_qwen"
}
```

### 5. 结果汇总 Agent (agent_result_summarizer)

**职责**：
- 汇总所有分析结果
- 格式化输出
- 生成报告

**配置**：
```json
{
  "name": "result_summarizer",
  "driver": "qwen",
  "role": "Report Generator",
  "prompt": "You are a report generator. Summarize the food analysis results into a clear, structured report.",
  "model": "qwen-max",
  "intent": "summarize",
  "service": "service_qwen"
}
```

### 6. 自动路由 Agent (agent_smart_router)

**职责**：
- 根据图片质量自动选择处理路径
- 判断是否需要并行处理
- 智能路由到不同处理节点

**配置**：
```json
{
  "name": "smart_router",
  "driver": "qwen",
  "role": "Intelligent Router",
  "prompt": "Analyze the image quality and food complexity to determine the best processing route.",
  "model": "qwen-max",
  "intent": "route",
  "service": "service_qwen",
  "route_mode": "auto",
  "route_targets": ["node_high_quality_handler", "node_standard_handler", "node_complex_handler"],
  "default_route": "node_standard_handler"
}
```

## 节点配置

### Service 节点

```json
{
  "id": "service_qwen",
  "type": "service",
  "config": {
    "name": "qwen",
    "service_type": "llm",
    "base_url": "https://dashscope.aliyuncs.com/compatible-mode/v1",
    "api_key": "${QWEN_API_KEY}"
  }
}
```

### Decision 节点

```json
{
  "id": "node_decision",
  "type": "decision_node",
  "config": {
    "policy": "first_match",
    "branches": [
      {
        "target": "node_single_food_handler",
        "name": "single_food",
        "condition": {
          "type": "state_equals",
          "key": "food_count",
          "value": "1"
        }
      },
      {
        "target": "node_multi_food_handler",
        "name": "multi_food",
        "condition": {
          "type": "state_equals",
          "key": "food_count",
          "value": "multiple"
        }
      }
    ]
  },
  "workflow": "workflow_food_analysis"
}
```

### Join 节点

```json
{
  "id": "node_join",
  "type": "join_node",
  "config": {
    "strategy": "all",
    "inbound": ["node_single_food_handler", "node_multi_food_handler"]
  },
  "workflow": "workflow_food_analysis"
}
```

### Loop 节点（可选，用于迭代处理）

```json
{
  "id": "node_loop",
  "type": "loop_node",
  "config": {
    "entry": "node_food_processor",
    "condition": {
      "type": "state_equals",
      "key": "has_more_foods",
      "value": "true"
    },
    "max_iterations": 10
  },
  "workflow": "workflow_food_analysis"
}
```

## 数据流设计

### 输入格式

```json
{
  "user": "user_id",
  "image_url": "https://example.com/food.jpg",
  "image_base64": "base64_encoded_image",
  "goal": "analyze_food",
  "steps": []
}
```

### 中间状态

```json
{
  "foods": [
    {
      "name": "apple",
      "confidence": 0.95,
      "bbox": [100, 100, 200, 200]
    }
  ],
  "food_count": 1,
  "image_quality": "high",
  "portions": [
    {
      "food": "apple",
      "weight": 150,
      "unit": "g"
    }
  ],
  "calories": {
    "total": 75,
    "breakdown": {
      "apple": 75
    }
  }
}
```

### 输出格式

```json
{
  "analysis_id": "analysis_123",
  "timestamp": "2024-11-23T10:00:00Z",
  "foods": [
    {
      "name": "apple",
      "confidence": 0.95,
      "portion": {
        "weight": 150,
        "unit": "g",
        "volume": null,
        "quantity": 1
      },
      "nutrition": {
        "calories": 75,
        "protein": 0.5,
        "carbs": 19.5,
        "fat": 0.3,
        "fiber": 2.5
      }
    }
  ],
  "summary": {
    "total_calories": 75,
    "total_foods": 1,
    "confidence_score": 0.95
  }
}
```

## 技术实现

### 使用的功能

1. **自动路由**
   - 使用 `route_mode: "auto"` 实现智能路由
   - 根据图片质量自动选择处理路径

2. **手动路由**
   - 使用 Decision 节点实现条件路由
   - 根据食物数量选择单食物/多食物路径

3. **并行处理**
   - 使用 Join 节点实现并行处理
   - 多食物同时分析和计算

4. **工具编排**
   - 使用 Tool Orchestrator 编排工具调用
   - 支持顺序、并行、故障转移策略

5. **状态管理**
   - 使用 FlowContext 管理工作流状态
   - 支持全局和局部变量

6. **条件转换**
   - 使用条件边实现动态路由
   - 支持多种条件类型

## 配置结构

### 完整配置示例

配置文件将包含：
- 1 个 Service 节点（Qwen 服务）
- 8 个 Agent 节点（各种处理 Agent）
- 1 个 Decision 节点（路由决策）
- 2 个 Join 节点（结果合并）
- 1 个 Loop 节点（可选，迭代处理）
- 1 个 Workflow 节点（主工作流定义）
- 多个 Agent Node（工作流中的 Agent 节点）
- 多个 Terminal 节点（工作流终止）

### 边配置

- Always 边：用于顺序执行
- Conditional 边：用于条件路由
- 支持 workflow 标识，组织边到特定工作流

## 扩展点

1. **数据库集成**
   - 存储分析历史
   - 用户偏好学习

2. **多模型支持**
   - 支持不同的视觉模型
   - 模型性能对比

3. **实时处理**
   - 流式处理支持
   - 增量结果更新

4. **错误处理**
   - 重试机制
   - 降级策略

## 性能优化

1. **缓存机制**
   - 缓存常见食物的识别结果
   - 缓存营养成分数据

2. **并行优化**
   - 多食物并行处理
   - 异步 I/O 优化

3. **资源管理**
   - 图片压缩
   - 批量处理

## 测试策略

1. **单元测试**
   - 每个 Agent 的独立测试
   - 节点逻辑测试

2. **集成测试**
   - 完整工作流测试
   - 端到端测试

3. **性能测试**
   - 并发处理测试
   - 响应时间测试

## 部署方案

1. **本地部署**
   - 单机运行
   - 适合开发测试

2. **云部署**
   - 容器化部署
   - 水平扩展

3. **API 服务**
   - RESTful API
   - GraphQL 支持

## 后续优化

1. **模型优化**
   - 自定义训练模型
   - 模型微调

2. **功能扩展**
   - 饮食建议
   - 健康分析
   - 历史记录

3. **用户体验**
   - Web 界面
   - 移动端 App
   - 实时反馈

