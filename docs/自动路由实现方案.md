# 自动路由实现方案

## 目标

实现由 LLM 自动分析输入并生成路由标签的自动路由功能。

> **状态**: ✅ 功能已完全实现并集成到 `ConfigDrivenAgent` 中。

## 实现思路

### 方案 A：扩展 ConfigDrivenAgent（推荐）

在现有的 `ConfigDrivenAgent` 中增加自动路由支持：

1. **Agent 配置增加字段**：
   - `route_mode: Option<String>` - "auto" 启用自动路由
   - `route_targets: Option<Vec<String>>` - 可路由的目标节点列表

2. **LLM 响应格式**：
   ```json
   {
     "response": "处理结果...",
     "route": "route_a",  // 路由标签
     "route_reason": "原因说明"
   }
   ```

3. **Agent 逻辑**：
   - 如果 `route_mode == "auto"`，解析 LLM 响应中的 `route` 字段
   - 构建 `AgentAction::Branch` 返回多个分支
   - 路由到对应的目标节点

### 方案 B：专门的 Router Agent 类型（未采用）

> **注意**: 此方案未被采用，最终选择了方案 A（扩展 ConfigDrivenAgent），因为它更简单且向后兼容。

创建一个新的 `router_node` 类型的方案（仅供参考）：

```json
{
  "id": "node_router",
  "type": "router_node",
  "config": {
    "agent": "agent_router",
    "targets": ["node_a", "node_b"],
    "default": "node_default"
  }
}
```

## 详细实现（方案 A）

### 1. 扩展 AgentConfig

```rust
// src/config/graph_config.rs

#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct AgentConfig {
    // ... 现有字段
    #[serde(default)]
    pub route_mode: Option<String>,  // "auto", "manual", None
    #[serde(default)]
    pub route_targets: Option<Vec<String>>,  // 可路由的目标节点 ID
    #[serde(default)]
    pub route_prompt: Option<String>,  // 路由专用的 prompt
}
```

### 2. 修改 ConfigDrivenAgent

```rust
// src/flow/loader.rs

impl Agent for ConfigDrivenAgent {
    async fn on_message(...) -> Result<AgentAction> {
        // ... 现有的 LLM 调用逻辑
        
        // 如果启用自动路由
        if self.profile.route_mode.as_deref() == Some("auto") {
            if let Some(route_targets) = &self.profile.route_targets {
                // 解析 LLM 响应中的路由信息
                if let Ok(payload) = serde_json::from_str::<Value>(&response_content) {
                    if let Some(route) = payload.get("route").and_then(|r| r.as_str()) {
                        // 构建路由分支
                        let mut branches = HashMap::new();
                        
                        // 查找匹配的目标节点
                        for target in route_targets {
                            if target.contains(route) || route == "default" {
                                let mut route_payload = payload.clone();
                                route_payload["route_label"] = json!(route);
                                
                                let route_message = StructuredMessage::new(route_payload)
                                    .into_agent_message(
                                        MessageRole::Agent,
                                        &self.profile.name,
                                        Some(target.clone()),
                                    )?;
                                
                                branches.insert(target.clone(), route_message);
                            }
                        }
                        
                        if !branches.is_empty() {
                            return Ok(AgentAction::Branch { branches });
                        }
                    }
                }
            }
        }
        
        // 默认返回 Continue
        Ok(AgentAction::Continue { message: Some(...) })
    }
}
```

### 3. 配置示例

```json
{
  "id": "agent_smart_router",
  "type": "agent",
  "config": {
    "name": "smart_router",
    "driver": "qwen",
    "role": "Intelligent Router",
    "prompt": "Analyze the user request and determine the appropriate route. You must respond with JSON format: {\"route\": \"urgent\" or \"normal\" or \"vip\", \"response\": \"your analysis\", \"reason\": \"routing reason\"}",
    "model": "qwen-max",
    "api_key": "your-api-key",
    "intent": "route",
    "service": "service_qwen",
    "route_mode": "auto",
    "route_targets": ["node_urgent_handler", "node_normal_handler", "node_vip_handler"],
    "route_prompt": "Based on the request urgency and user type, route to: urgent, normal, or vip"
  }
}
```

### 4. 工作流配置

```json
{
  "nodes": [
    {
      "id": "node_router",
      "type": "agent_node",
      "config": {
        "agent": "agent_smart_router"
      },
      "workflow": "workflow_auto_routing"
    },
    {
      "id": "node_urgent_handler",
      "type": "agent_node",
      "config": {
        "agent": "agent_urgent_handler"
      },
      "workflow": "workflow_auto_routing"
    },
    {
      "id": "node_normal_handler",
      "type": "agent_node",
      "config": {
        "agent": "agent_normal_handler"
      },
      "workflow": "workflow_auto_routing"
    }
  ],
  "edges": [
    {
      "from": "node_router",
      "to": "node_urgent_handler",
      "type": "always",
      "workflow": "workflow_auto_routing"
    },
    {
      "from": "node_router",
      "to": "node_normal_handler",
      "type": "always",
      "workflow": "workflow_auto_routing"
    }
  ]
}
```

## LLM Prompt 设计建议

### 路由 Prompt 模板

```
You are an intelligent routing assistant. Your task is to analyze the user request and determine the best route.

Available routes:
- urgent: For urgent requests requiring immediate attention
- normal: For standard requests with normal priority
- vip: For VIP customers or premium requests

You must respond with JSON format:
{
  "route": "urgent" | "normal" | "vip",
  "response": "your analysis of the request",
  "reason": "brief explanation of why this route was chosen"
}

User request: {user_input}
```

### 多分支路由

如果需要路由到多个目标（并行处理）：

```json
{
  "route": ["urgent", "vip"],  // 多个路由标签
  "response": "...",
  "branches": {
    "urgent": "urgent analysis...",
    "vip": "vip analysis..."
  }
}
```

## 实现检查清单

- [x] 扩展 `AgentConfig` 添加路由相关字段
- [x] 修改 `ConfigDrivenAgent::on_message` 支持自动路由
- [x] 实现路由标签解析逻辑
- [x] 支持单路由和多路由模式
- [x] 添加路由失败的回退机制
- [x] 更新配置示例和文档
- [x] 所有功能已实现并测试

## 实现状态

✅ **功能已实现** - 自动路由功能已经集成到 `ConfigDrivenAgent` 中。

### 实现特性

1. **自动路由模式**: 通过 `route_mode: "auto"` 启用
2. **路由目标配置**: 通过 `route_targets` 指定可路由的目标节点
3. **路由提示**: 支持自定义 `route_prompt` 指导 LLM 生成路由标签
4. **默认路由**: 通过 `default_route` 设置路由失败时的回退目标
5. **智能匹配**: 自动从目标节点名称中提取路由关键词进行匹配
6. **JSON 解析**: 支持从 JSON 响应或代码块中提取路由信息
7. **多路由支持**: 支持单路由和多路由（数组）模式

### 配置示例

参考 `configs/graph_config_auto_routing.json` 查看完整的自动路由配置示例。

## 错误处理

1. **LLM 响应格式错误**：回退到默认路由或 Continue
2. **路由标签不匹配**：使用默认路由或记录警告
3. **目标节点不存在**：跳过无效路由，继续执行其他路由

## 优势

- ✅ 利用现有架构，最小化改动
- ✅ 配置简单，只需在 Agent 配置中添加字段
- ✅ 灵活，可以轻松扩展支持更复杂的路由逻辑
- ✅ 向后兼容，不影响现有功能

