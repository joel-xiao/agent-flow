# 内置工具使用说明

## 概述

AgentFlow 框架提供了内置工具系统，支持在工作流中调用各种工具。内置工具**无需手动注册**，框架会自动加载。

## 内置工具列表

### 1. DownloaderTool（文件下载工具）

**功能**：自动从消息历史中提取 URL 并下载文件到本地

**支持的文件类型**：
- 图片：PNG, JPG, GIF, WebP, SVG
- 音频：MP3, WAV, OGG, AAC
- 视频：MP4, MPEG, MOV, AVI, WebM
- 文档：PDF, JSON, TXT

**配置参数**（可选）：
```json
{
  "url": "直接指定 URL（可选，不提供时自动从上下文提取）",
  "save_dir": "保存目录（默认 downloads，项目根目录下）",
  "filename_prefix": "文件名前缀（默认 file）"
}
```

**示例配置**：
```rust
// 保存到项目根目录 downloads/ (默认)
ToolStep::new("downloader", serde_json::json!({}))

// 保存到自定义目录 output/images/
ToolStep::new("downloader", serde_json::json!({
    "save_dir": "output/images",
    "filename_prefix": "marketing"
}))

// 保存到绝对路径
ToolStep::new("downloader", serde_json::json!({
    "save_dir": "/Users/username/Downloads",
    "filename_prefix": "product"
}))
```

**自动识别 URL 字段**：
- `image_url`
- `url`
- `file_url`
- `download_url`

**返回结果**：
```json
{
  "success": true,
  "url": "https://example.com/image.png",
  "filepath": "generated_images/file_1234567890.png",
  "filename": "file_1234567890.png",
  "size_bytes": 102400,
  "extension": "png",
  "content_type": "image/png"
}
```

### 2. ImageGeneratorTool（图片生成工具）

**功能**：AI 图片生成工具（待实现）

## 在 JSON 配置中使用内置工具

### 1. 定义 tool_node

```json
{
  "id": "tool_downloader",
  "type": "tool_node",
  "config": {
    "pipeline": "download_file"
  },
  "workflow": "workflow_marketing"
}
```

### 2. 添加边（连接节点）

```json
{
  "from": "agent_image_generator",
  "to": "tool_downloader",
  "type": "always",
  "workflow": "workflow_marketing"
}
```

### 3. 在应用代码中注册 Pipeline

```rust
use agentflow::tools::{ToolOrchestrator, ToolPipeline, ToolStep, ToolStrategy};

// 创建 ToolOrchestrator
let mut orchestrator = ToolOrchestrator::new(bundle.tools.clone());

// 注册下载 pipeline（调用内置工具 downloader）
let download_pipeline = ToolPipeline::new(
    "download_file",
    ToolStrategy::Sequential(vec![
        ToolStep::new("downloader", serde_json::json!({}))
    ])
);
orchestrator.register_pipeline(download_pipeline)?;

// 将 orchestrator 注入到执行器
let executor = FlowExecutor::new(bundle.flow, bundle.agents, bundle.tools)
    .with_tool_orchestrator(Arc::new(orchestrator));
```

## 完整示例

### JSON 配置（部分）

```json
{
  "nodes": [
    {
      "id": "agent_image_generator",
      "type": "agent",
      "config": {
        "name": "image_generator",
        "model": "wan2.5-t2i-preview",
        "endpoint": "https://dashscope.aliyuncs.com/api/v1/services/aigc/text2image/image-synthesis"
      }
    },
    {
      "id": "tool_downloader",
      "type": "tool_node",
      "config": {
        "pipeline": "download_file"
      }
    }
  ],
  "edges": [
    {
      "from": "agent_image_generator",
      "to": "tool_downloader",
      "type": "always"
    }
  ]
}
```

### Rust 代码

```rust
use agentflow::tools::{ToolOrchestrator, ToolPipeline, ToolStep, ToolStrategy};
use agentflow::{FlowExecutor, GraphConfig};
use std::sync::Arc;

#[tokio::main]
async fn main() -> Result<(), Box<dyn std::error::Error>> {
    // 1. 加载配置
    let graph_config = GraphConfig::from_json(&config_json)?;
    let bundle = graph_config.load_workflow(workflow_id)?;
    
    // 2. 创建 ToolOrchestrator（内置工具已自动注册）
    let mut orchestrator = ToolOrchestrator::new(bundle.tools.clone());
    orchestrator.register_pipeline(ToolPipeline::new(
        "download_file",
        ToolStrategy::Sequential(vec![
            ToolStep::new("downloader", serde_json::json!({}))
        ])
    ))?;
    
    // 3. 执行工作流
    let executor = FlowExecutor::new(bundle.flow, bundle.agents, bundle.tools)
        .with_tool_orchestrator(Arc::new(orchestrator));
    
    let result = executor.start(ctx, initial_message).await?;
    
    Ok(())
}
```

## 扩展自定义工具

### 1. 实现 Tool trait

```rust
use async_trait::async_trait;
use crate::tools::tool::{Tool, ToolInvocation};
use crate::agent::AgentMessage;
use crate::error::Result;
use crate::state::FlowContext;

pub struct MyCustomTool;

#[async_trait]
impl Tool for MyCustomTool {
    fn name(&self) -> &'static str {
        "my_custom_tool"
    }
    
    async fn call(
        &self,
        invocation: ToolInvocation,
        ctx: &FlowContext
    ) -> Result<AgentMessage> {
        // 实现你的工具逻辑
        let result = serde_json::json!({
            "status": "success",
            "data": "custom result"
        });
        
        Ok(AgentMessage {
            id: crate::agent::message::uuid(),
            role: MessageRole::Tool,
            from: self.name().to_string(),
            to: None,
            content: result.to_string(),
            metadata: None,
        })
    }
}
```

### 2. 注册自定义工具

```rust
// 在加载工作流后注册
bundle.tools.register(Arc::new(MyCustomTool));

// 创建 pipeline 使用自定义工具
orchestrator.register_pipeline(ToolPipeline::new(
    "my_custom_pipeline",
    ToolStrategy::Sequential(vec![
        ToolStep::new("my_custom_tool", serde_json::json!({
            "param1": "value1"
        }))
    ])
))?;
```

### 3. 在 JSON 中使用

```json
{
  "id": "tool_custom",
  "type": "tool_node",
  "config": {
    "pipeline": "my_custom_pipeline"
  }
}
```

## 工具策略

### Sequential（顺序执行）

按顺序执行工具，前一个工具的输出可用于下一个工具：

```rust
ToolStrategy::Sequential(vec![
    ToolStep::new("tool1", input1),
    ToolStep::new("tool2", input2),
])
```

### Parallel（并行执行）

同时执行多个工具，最后汇总结果：

```rust
ToolStrategy::Parallel(vec![
    ToolStep::new("tool1", input1),
    ToolStep::new("tool2", input2),
])
```

### Fallback（故障转移）

按顺序尝试工具，直到一个成功：

```rust
ToolStrategy::Fallback(vec![
    ToolStep::new("primary_tool", input),
    ToolStep::new("backup_tool", input),
])
```

## 最佳实践

1. **内置工具优先**：优先使用框架提供的内置工具
2. **自动注册**：内置工具无需手动注册，框架自动加载
3. **参数简洁**：尽量利用自动提取功能，减少显式参数
4. **Pipeline 复用**：创建可复用的 pipeline 组合
5. **错误处理**：工具应返回结构化的错误信息

## 架构设计

```
┌─────────────────────┐
│   JSON 配置          │
│  ┌──────────────┐   │
│  │  tool_node   │   │
│  │  pipeline:   │   │
│  │  "download"  │   │
│  └──────────────┘   │
└──────────┬──────────┘
           │
┌──────────▼──────────┐
│  FlowExecutor       │
│  with_tool_         │
│  orchestrator       │
└──────────┬──────────┘
           │
┌──────────▼──────────┐
│  ToolOrchestrator   │
│  - pipelines        │
│  - registry         │
└──────────┬──────────┘
           │
┌──────────▼──────────┐
│  ToolRegistry       │
│  - downloader  ✅   │ ← 内置工具（自动注册）
│  - image_gen   ✅   │
│  - custom_tool      │ ← 自定义工具
└─────────────────────┘
```

## 总结

- ✅ 内置工具**无需手动注册**，框架自动加载
- ✅ 支持**图片、音频、视频、文档**下载
- ✅ 自动从上下文**提取 URL**
- ✅ 支持**自定义工具扩展**
- ✅ 灵活的**执行策略**（顺序/并行/故障转移）
- ✅ 完全**JSON 配置驱动**

